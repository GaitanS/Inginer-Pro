{% extends 'base.html' %}
{% block content %}
<div class="bg-gray-700 rounded-lg border border-gray-600 shadow-sm p-6 overflow-auto h-full">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-white">Equipment IPs</h2>
        <div class="flex items-center gap-2">
            <a href="{% url 'equipment' %}" class="px-4 py-1.5 bg-gray-600 text-gray-300 rounded text-xs font-medium hover:bg-gray-500">List</a>
            <a href="{% url 'equipment_ips' %}" class="px-4 py-1.5 bg-preh-petrol text-white rounded text-xs font-medium">IPs</a>
            <a href="{% url 'equipment_photos' %}" class="px-4 py-1.5 bg-gray-600 text-gray-300 rounded text-xs font-medium hover:bg-gray-500">Photos</a>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for equip in equipment_list %}
        <div id="ip-card-{{ equip.id }}" class="border border-gray-600 rounded-lg overflow-hidden flex flex-col shadow-sm">
            <div class="bg-gray-800 p-3 border-b border-gray-600 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-lg text-white">{{ equip.station }}</h3>
                    {% with progress=equip.get_device_completion %}
                    <span class="text-xs px-2 py-0.5 rounded-full border {% if progress == 100 %}bg-green-900/50 text-green-400 border-green-700{% elif progress >= 50 %}bg-yellow-900/50 text-yellow-400 border-yellow-700{% else %}bg-gray-700 text-gray-400 border-gray-600{% endif %}">{{ progress }}%</span>
                    {% endwith %}
                </div>
                <button hx-post="{% url 'device_add' equip.id %}" hx-target="#devices-{{ equip.id }}" hx-swap="beforeend" class="text-preh-light-blue hover:text-white p-1 rounded hover:bg-gray-700 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-900/50 text-gray-300">
                    <tr>
                        <th class="p-2 border-b border-gray-700 w-8"></th>
                        <th class="p-2 border-b border-gray-700">Equipment</th>
                        <th class="p-2 border-b border-gray-700">Name</th>
                        <th class="p-2 border-b border-gray-700">IP address</th>
                    </tr>
                </thead>
                <tbody id="devices-{{ equip.id }}" class="divide-y divide-gray-700">
                    {% for device in equip.devices.all %}
                    <tr id="device-row-{{ device.id }}" class="hover:bg-gray-800/50 group">
                        <td class="p-0 text-center border-r border-gray-700"><button onclick="confirmDeviceDelete({{ device.id }})" class="p-2 text-red-500 hover:text-red-400 transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button></td>
                        <td class="p-0 border-r border-gray-700"><input class="w-full bg-transparent p-2 focus:outline-none focus:bg-gray-700 text-gray-200" value="{{ device.device_type }}" hx-post="{% url 'device_update' device.id %}" hx-trigger="change" hx-vals='{"field": "device_type"}' hx-swap="none" name="value"></td>
                        <td class="p-0 border-r border-gray-700"><input class="w-full bg-transparent p-2 focus:outline-none focus:bg-gray-700 text-gray-200" value="{{ device.name }}" hx-post="{% url 'device_update' device.id %}" hx-trigger="change" hx-vals='{"field": "name"}' hx-swap="none" name="value"></td>
                        <td class="p-0"><input class="w-full bg-transparent p-2 focus:outline-none focus:bg-gray-700 font-mono text-preh-light-blue" value="{{ device.ip_address }}" hx-post="{% url 'device_update' device.id %}" hx-trigger="change" hx-vals='{"field": "ip_address"}' hx-swap="none" name="value"></td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row"><td colspan="4" class="p-4 text-center text-gray-500 text-sm">No devices. Click + to add.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% empty %}
        <div class="col-span-2 p-8 text-center text-gray-400">No equipment found.</div>
        {% endfor %}
    </div>
</div>

<div id="device-delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4 border border-gray-700">
        <h3 class="text-lg font-bold text-white mb-2">Delete Device?</h3>
        <p class="text-gray-400 mb-6">Are you sure you want to delete this device row?</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeDeviceDeleteModal()" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition-colors">Cancel</button>
            <button id="confirm-device-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">Delete</button>
        </div>
    </div>
</div>

<script>
let deleteDeviceId = null;
function confirmDeviceDelete(id) { deleteDeviceId = id; document.getElementById('device-delete-modal').classList.remove('hidden'); }
function closeDeviceDeleteModal() { document.getElementById('device-delete-modal').classList.add('hidden'); deleteDeviceId = null; }
document.getElementById('confirm-device-delete-btn').addEventListener('click', function() {
    if (deleteDeviceId) {
        htmx.ajax('POST', '/device/delete/' + deleteDeviceId + '/', {target: '#device-row-' + deleteDeviceId, swap: 'outerHTML'});
        closeDeviceDeleteModal();
    }
});
document.getElementById('device-delete-modal').addEventListener('click', function(e) { if (e.target === this) closeDeviceDeleteModal(); });
document.body.addEventListener('htmx:afterSwap', function() { if (typeof lucide !== 'undefined') lucide.createIcons(); });
</script>
{% endblock %}
