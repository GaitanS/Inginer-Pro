{% extends 'base.html' %}
{% load validation_extras %}

{% block content %}
<div class="flex h-full gap-6 pb-10">
    <!-- Station Sidebar -->
    <div class="w-64 flex-shrink-0 flex flex-col gap-2">
        <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider mb-2">Select Station</h3>
        <div
            class="bg-gray-700 rounded-lg border border-gray-600 shadow-sm overflow-hidden flex flex-col max-h-[calc(100vh-200px)] overflow-y-auto">
            {% for equip in equipment_list %}
            <a href="?equipment_id={{ equip.id }}"
                class="text-left px-4 py-3 text-sm font-medium border-l-4 transition-all flex justify-between items-center {% if selected_equipment.id == equip.id %}bg-gray-600/50 border-preh-petrol text-white{% else %}border-transparent text-gray-300 hover:bg-gray-600{% endif %}">
                <span class="truncate">{{ equip.station }}</span>
                {% with progress=equip.get_validation_progress %}
                <span id="sidebar-progress-{{ equip.id }}"
                    class="text-[10px] px-1.5 py-0.5 rounded-full border font-bold min-w-[36px] text-center {% if progress == 100 %}bg-green-900/30 text-green-400 border-green-800{% elif progress >= 50 %}bg-yellow-900/30 text-yellow-400 border-yellow-800{% else %}bg-red-900/30 text-red-400 border-red-800{% endif %}">{{ progress }}%</span>
                {% endwith %}
            </a>
            {% empty %}
            <p class="text-gray-400 text-sm p-4">No equipment found.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 space-y-6 overflow-y-auto pr-2">
        {% if selected_equipment %}
        <!-- Header -->
        <div class="mb-4">
            <h2 class="text-2xl font-bold text-gray-100 flex items-center gap-2">
                <i data-lucide="shield-check" class="w-7 h-7 text-preh-light-blue"></i>
                Validation Protocol
            </h2>
            <p class="text-gray-400 mt-1">Validare Echipament: <span class="font-bold text-gray-200">{{ selected_equipment.station }}</span></p>
        </div>

        <!-- Status Card -->
        {% with progress=selected_equipment.get_validation_progress %}
        <div id="status-card"
            class="bg-gradient-to-r from-gray-800 to-gray-700 p-6 rounded-lg border border-gray-600 flex justify-between items-center shadow-sm">
            <div>
                <h3 class="text-lg font-bold text-white mb-1">Status Validare</h3>
                <p class="text-sm text-gray-400">{{ ok_count|default:0 }} / {{ total_items }} Puncte Validate (OK)</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <span
                        class="text-2xl font-bold {% if progress == 100 %}text-green-500{% elif progress >= 50 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ progress }}%</span>
                    <span class="text-xs text-gray-500 block">Progres</span>
                </div>
                <div class="w-24 h-2 bg-gray-600 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-500 {% if progress == 100 %}bg-green-500{% elif progress >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                        style="width: {{ progress }}%;"></div>
                </div>
            </div>
        </div>
        {% endwith %}

        <!-- Categories -->
        {% for category in categories %}
        <div class="space-y-4">
            <h4 class="font-bold text-lg text-preh-light-blue border-b border-gray-600 pb-2">{{ forloop.counter }}. {{ category.title }}</h4>
            <div class="overflow-x-auto rounded-lg border border-gray-600 shadow-sm">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs font-semibold">
                        <tr>
                            <th class="px-4 py-3 w-32 border-r border-gray-700">Ref IATF / VDA</th>
                            <th class="px-4 py-3 w-1/4 border-r border-gray-700">Test Fizic (Ce facem?)</th>
                            <th class="px-4 py-3 w-1/4 border-r border-gray-700">Rezultat Așteptat</th>
                            <th class="px-4 py-3 w-1/4 border-r border-gray-700">Exemplu Concret</th>
                            <th class="px-4 py-3 w-32 text-center">Rezultat</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700 bg-gray-700">
                        {% for item in category.items.all %}
                        <tr class="hover:bg-gray-600/50 transition-colors">
                            <td class="px-4 py-3 align-top border-r border-gray-700 font-mono text-xs text-gray-400">
                                <div class="mb-1">IATF: <span class="text-gray-200 font-bold">{{ item.ref_iatf }}</span>
                                </div>
                                <div>VDA: {{ item.ref_vda }}</div>
                            </td>
                            <td class="px-4 py-3 align-top border-r border-gray-700 text-gray-200 font-medium">{{ item.test }}</td>
                            <td class="px-4 py-3 align-top border-r border-gray-700 text-gray-300">{{ item.expected }}
                            </td>
                            <td class="px-4 py-3 align-top border-r border-gray-700 text-gray-400 italic">{{ item.example }}</td>
                            <td class="px-4 py-3 align-top">
                                {% with status=results|get_item:item.id %}
                                <div id="buttons-{{ item.id }}" class="flex flex-col gap-2 items-center">
                                    <div class="flex gap-1 w-full">
                                        <button hx-post="{% url 'submit_validation' selected_equipment.id item.id %}"
                                            hx-vals='{"status": "OK"}' hx-target="#buttons-{{ item.id }}"
                                            hx-swap="outerHTML" hx-trigger="click"
                                            class="flex-1 py-1 px-2 rounded text-xs font-bold transition-all border {% if status == 'OK' %}bg-green-600 border-green-500 text-white{% else %}bg-gray-800 border-gray-600 text-gray-400 hover:border-green-500 hover:text-green-500{% endif %}">OK</button>
                                        <button hx-post="{% url 'submit_validation' selected_equipment.id item.id %}"
                                            hx-vals='{"status": "NOK"}' hx-target="#buttons-{{ item.id }}"
                                            hx-swap="outerHTML" hx-trigger="click"
                                            class="flex-1 py-1 px-2 rounded text-xs font-bold transition-all border {% if status == 'NOK' %}bg-red-600 border-red-500 text-white{% else %}bg-gray-800 border-gray-600 text-gray-400 hover:border-red-500 hover:text-red-500{% endif %}">NOK</button>
                                    </div>
                                    {% if status %}
                                    <span class="text-[10px] text-gray-500 uppercase">Validat</span>
                                    {% endif %}
                                </div>
                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- Important Note -->
        <div class="p-4 bg-yellow-900/20 rounded-lg border border-yellow-800 flex items-start gap-3">
            <div class="bg-yellow-900/50 p-2 rounded-full text-yellow-400">
                <i data-lucide="triangle-alert" class="w-5 h-5"></i>
            </div>
            <div>
                <h5 class="font-bold text-yellow-200 text-sm">Notă Importantă</h5>
                <p class="text-sm text-yellow-300 mt-1">Toate punctele "NOK" trebuie tratate ca puncte deschise în lista
                    de acțiuni (LOP). Echipamentul nu poate fi validat final până când toate punctele critice de
                    siguranță nu sunt "OK".</p>
            </div>
        </div>

        {% else %}
        <div class="flex items-center justify-center h-64 text-gray-400">
            <p>Select equipment from the sidebar to begin validation.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', function () {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
</script>
{% endblock %}