{% extends 'base.html' %}
{% load static %}
{% load validation_extras %}

{% block content %}
<div
    class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col h-[calc(100vh-180px)]">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <a href="?tab=bom"
            class="px-6 py-3 text-sm font-medium transition-colors border-b-2 {% if active_tab == 'bom' %}border-preh-petrol text-preh-petrol dark:text-preh-light-blue{% else %}border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400{% endif %}">
            Listă Materiale (BOM)
        </a>
        <a href="?tab=history"
            class="px-6 py-3 text-sm font-medium transition-colors border-b-2 {% if active_tab == 'history' %}border-preh-petrol text-preh-petrol dark:text-preh-light-blue{% else %}border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400{% endif %}">
            Istoric Revizii
        </a>
    </div>

    {% if active_tab == 'bom' %}
    <!-- BOM Tab Content -->
    <div class="flex flex-col h-full">
        <!-- Toolbar -->
        <div
            class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800">
            <div class="flex gap-3 items-center">
                <button hx-post="/bom/add/" hx-target="#bom-tbody" hx-swap="beforeend"
                    class="flex items-center gap-1 px-3 py-1.5 bg-preh-petrol text-white rounded hover:bg-preh-grey-blue text-xs font-medium transition-colors">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                    Adaugă Rând
                </button>
                <div class="flex items-center gap-2 border-l border-gray-300 dark:border-gray-600 pl-3">
                    <input type="color" id="new-column-color" value="#6BB8D4"
                        class="w-8 h-8 cursor-pointer rounded border border-gray-300 dark:border-gray-600"
                        title="Alege culoare coloană" />
                    <input type="text" id="new-column-name" placeholder="Nume coloană nouă"
                        class="px-2 py-1.5 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600 w-36" />
                    <button onclick="addNewColumn()"
                        class="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-medium transition-colors">
                        <i data-lucide="columns" class="w-3.5 h-3.5"></i>
                        Adaugă Coloană
                    </button>
                </div>
            </div>
            <div class="text-xs text-gray-500">
                {{ bom_data|length }} articole
            </div>
        </div>

        <!-- BOM Table -->
        <div class="flex-1 overflow-x-auto overflow-y-auto">
            <table class="min-w-full text-sm text-left border-collapse" style="min-width: 1200px;">
                <thead
                    class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-100 font-semibold sticky top-0 shadow-sm z-20">
                    <tr>
                        <!-- Delete column header (first) -->
                        <th
                            class="p-2 border-b dark:border-gray-700 w-10 bg-gray-100 dark:bg-gray-800 text-center text-xs text-gray-500 sticky left-0 z-30">
                            <i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i>
                        </th>
                        <th class="p-3 border-b dark:border-gray-700 min-w-[150px] bg-gray-100 dark:bg-gray-800">
                            Stație</th>
                        <th class="p-3 border-b dark:border-gray-700 min-w-[180px]">Material</th>
                        <th class="p-3 border-b dark:border-gray-700 min-w-[280px]">Descriere</th>
                        <th class="p-3 border-b dark:border-gray-700 w-16 text-center">Cant.</th>
                        {% for variant in variants %}
                        <th class="p-2 border-b dark:border-gray-700 min-w-[100px] text-center text-xs relative"
                            style="background-color: {{ variant.color }}; color: {{ variant.color|contrast_color }};">
                            <div class="flex items-center justify-between gap-1">
                                <input type="color" value="{{ variant.color }}"
                                    hx-post="/bom/variant/color/{{ variant.id }}/" hx-trigger="change" name="color"
                                    class="w-6 h-6 cursor-pointer rounded border border-white/30"
                                    title="Schimbă culoarea" />
                                <span class="truncate font-bold flex-1 text-center">{{ variant.name }}</span>
                                <button hx-post="/bom/variant/delete/{{ variant.id }}/"
                                    hx-confirm="Ștergeți varianta '{{ variant.name }}'?"
                                    class="text-current opacity-60 hover:opacity-100 transition-opacity"
                                    title="Șterge varianta">
                                    <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="bom-tbody" class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for data in bom_data %}
                    {% include "partials/bom_row.html" %}
                    {% empty %}
                    <tr>
                        <td colspan="100" class="p-8 text-center text-gray-400">
                            Nu există articole BOM. Apăsați "Adaugă Rând" pentru a începe.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}
    <!-- History Tab Content -->
    <div class="flex-1 overflow-auto p-6">
        <table class="w-full text-sm text-left">
            <thead class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-100 font-semibold">
                <tr>
                    <th class="p-3 border-b dark:border-gray-700">Versiune</th>
                    <th class="p-3 border-b dark:border-gray-700">Registru</th>
                    <th class="p-3 border-b dark:border-gray-700">Modificări</th>
                    <th class="p-3 border-b dark:border-gray-700">Creat de</th>
                    <th class="p-3 border-b dark:border-gray-700">Data Creare</th>
                    <th class="p-3 border-b dark:border-gray-700">Aprobat de</th>
                    <th class="p-3 border-b dark:border-gray-700">Data Aprobare</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for item in history_items %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td class="p-3 font-mono font-bold text-preh-petrol dark:text-preh-light-blue">v{{ item.version }}
                    </td>
                    <td class="p-3">{{ item.register }}</td>
                    <td class="p-3">{{ item.changes }}</td>
                    <td class="p-3">{{ item.created_by }}</td>
                    <td class="p-3">{{ item.date_created }}</td>
                    <td class="p-3">{{ item.released_by }}</td>
                    <td class="p-3">{{ item.date_released }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="p-8 text-center text-gray-400">
                        Nu există istoric revizii.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
    function addNewRow() {
        fetch('/bom/add/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        }).then(response => {
            window.location.reload();
        });
    }

    function addNewColumn() {
        const name = document.getElementById('new-column-name').value.trim();
        const color = document.getElementById('new-column-color').value;

        if (!name) {
            alert('Introduceți un nume pentru coloană');
            document.getElementById('new-column-name').focus();
            return;
        }

        fetch('/bom/variant/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: 'name=' + encodeURIComponent(name) + '&color=' + encodeURIComponent(color)
        }).then(response => {
            window.location.reload();
        });
    }

    // Enter key to add column
    document.getElementById('new-column-name')?.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') addNewColumn();
    });

    // Reinitialize icons after HTMX swap
    document.body.addEventListener('htmx:afterSwap', function () {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{% endblock %}